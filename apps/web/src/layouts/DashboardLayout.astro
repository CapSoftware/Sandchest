---
import BaseLayout from './BaseLayout.astro'

interface Props {
  title: string
  active: 'sandboxes' | 'keys' | 'settings'
}

const { title, active } = Astro.props

const navItems = [
  { href: '/dashboard', label: 'Sandboxes', id: 'sandboxes' as const },
  { href: '/dashboard/keys', label: 'API Keys', id: 'keys' as const },
  { href: '/dashboard/settings', label: 'Settings', id: 'settings' as const },
]
---

<BaseLayout title={`${title} â€” Sandchest`}>
  <div class="dash">
    <aside class="dash-sidebar">
      <a href="/" class="dash-logo" aria-label="Back to home">
        <img src="/sandchest-icon.svg" alt="Sandchest" height="28" />
      </a>
      <nav class="dash-nav">
        {navItems.map((item) => (
          <a
            href={item.href}
            class:list={['dash-nav-item', { active: active === item.id }]}
          >
            {item.label}
          </a>
        ))}
      </nav>
      <div class="dash-sidebar-footer">
        <button id="sign-out-btn" class="dash-nav-item sign-out">Sign out</button>
      </div>
    </aside>

    <!-- Mobile header -->
    <header class="dash-mobile-header">
      <a href="/" class="dash-logo" aria-label="Back to home">
        <img src="/sandchest-icon.svg" alt="Sandchest" height="24" />
      </a>
      <button id="mobile-dash-btn" class="dash-mobile-toggle" aria-label="Toggle menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
          <line x1="4" y1="7" x2="20" y2="7" />
          <line x1="4" y1="12" x2="20" y2="12" />
          <line x1="4" y1="17" x2="20" y2="17" />
        </svg>
      </button>
    </header>

    <!-- Mobile dropdown -->
    <nav id="mobile-dash-menu" class="dash-mobile-menu hidden">
      {navItems.map((item) => (
        <a
          href={item.href}
          class:list={['dash-nav-item', { active: active === item.id }]}
        >
          {item.label}
        </a>
      ))}
      <button id="mobile-sign-out-btn" class="dash-nav-item sign-out">Sign out</button>
    </nav>

    <main class="dash-main">
      <slot />
    </main>
  </div>
</BaseLayout>

<style>
  .dash {
    display: flex;
    min-height: 100vh;
  }

  .dash-sidebar {
    width: 220px;
    min-width: 220px;
    border-right: 1px solid var(--color-border-weak);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    position: sticky;
    top: 0;
    height: 100vh;
  }

  .dash-logo {
    display: block;
    padding: 0 8px;
  }

  .dash-logo:hover {
    text-decoration: none;
  }

  .dash-nav {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .dash-nav-item {
    display: block;
    padding: 8px 12px;
    font-size: 13px;
    color: var(--color-text-weak);
    border-radius: 6px;
    transition: color 0.15s, background-color 0.15s;
    font-family: var(--font-mono);
    text-decoration: none;
    border: none;
    background: none;
    cursor: pointer;
    text-align: left;
    width: 100%;
  }

  .dash-nav-item:hover {
    color: var(--color-text-strong);
    background: var(--color-surface);
    text-decoration: none;
  }

  .dash-nav-item.active {
    color: var(--color-text-strong);
    background: var(--color-surface);
  }

  .dash-sidebar-footer {
    margin-top: auto;
  }

  .sign-out {
    color: var(--color-text-weak);
    font-size: 13px;
  }

  .sign-out:hover {
    color: hsl(0, 70%, 60%);
  }

  .dash-main {
    flex: 1;
    padding: 32px 40px;
    min-width: 0;
  }

  /* Mobile header */
  .dash-mobile-header {
    display: none;
  }

  .dash-mobile-menu {
    display: none;
  }

  .dash-mobile-toggle {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-strong);
    padding: 4px;
  }

  @media (max-width: 768px) {
    .dash-sidebar {
      display: none;
    }

    .dash-mobile-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--color-border-weak);
      position: sticky;
      top: 0;
      background: var(--color-background);
      z-index: 10;
    }

    .dash-mobile-menu {
      flex-direction: column;
      gap: 2px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--color-border-weak);
      background: var(--color-background);
      position: sticky;
      top: 57px;
      z-index: 9;
    }

    .dash-mobile-menu:not(.hidden) {
      display: flex;
    }

    .dash {
      flex-direction: column;
    }

    .dash-main {
      padding: 24px 20px;
    }
  }

  .hidden {
    display: none !important;
  }
</style>

<script>
  import { authClient } from '../lib/auth-client'

  // Sign out handlers
  async function handleSignOut() {
    await authClient.signOut()
    window.location.href = '/login'
  }

  document.getElementById('sign-out-btn')?.addEventListener('click', handleSignOut)
  document.getElementById('mobile-sign-out-btn')?.addEventListener('click', handleSignOut)

  // Mobile menu toggle
  const mobileBtn = document.getElementById('mobile-dash-btn')
  const mobileMenu = document.getElementById('mobile-dash-menu')

  mobileBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden')
  })
</script>
